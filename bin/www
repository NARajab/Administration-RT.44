console.log("Executing bin/www...");

require("dotenv").config();
const cron = require("node-cron");
const app = require("../app/index");
const { databaseValidation } = require("../config/database");
const { createDuesObligat } = require("../app/controller/duesController");
const WhatsappMessage = require("../app/controller/messageController");

console.log("Starting server...");

databaseValidation().then(() => {
  console.log("Database validation complete.");
  // Uncomment this if you need WhatsappMessage initialization
  // WhatsappMessage.initializeClient();

  cron.schedule(
    "0 0 1 * *",
    async () => {
      console.log("Cron job started...");
      await new Promise((resolve) => setTimeout(resolve, 5000));
      createDuesObligat();
    },
    {
      scheduled: true,
      timezone: "Asia/Jakarta",
    }
  );

  const { PORT = 3000, HOST = 'localhost' } = process.env;

  app.listen(PORT, () => {
    console.log(`Server is running at http://${HOST}:${PORT}`);
  });
}).catch(err => {
  console.error("Failed to validate database connection:", err);
});
